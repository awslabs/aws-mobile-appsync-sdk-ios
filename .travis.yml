language: swift
osx_image: xcode13.2
env:
  global:
  - FRAMEWORK_NAME=AWSAppSync
  - BUILD_FOLDER=./build
xcode_workspace: AWSAppSyncClient.xcworkspace
xcode_scheme: AWSAppSync
before_install:
- openssl aes-256-cbc -K $encrypted_6919a533707f_key -iv $encrypted_6919a533707f_iv
  -in AWSAppSyncIntegrationTests/appsync_test_credentials.json.enc
  -out AWSAppSyncIntegrationTests/appsync_test_credentials.json
  -d
- brew update
- brew outdated carthage || brew upgrade carthage
- gem install cocoapods -v '1.9.3'
before_deploy:
- bash ./build-support/carthage-build.sh build --no-skip-current
- bash ./build-support/carthage-build.sh archive $FRAMEWORK_NAME
- bash ./build-support/build-xcframeworks.sh $FRAMEWORK_NAME
script:
- xcodebuild -quiet -workspace AWSAppSyncClient.xcworkspace -scheme AWSAppSync build test -destination 'platform=iOS Simulator,name=iPhone 11,OS=latest'
deploy:
- provider: releases
  api_key:
    secure: "sdazI+kG88gwh3ssS66BB71if2x2jgS+jfGW+vhSl4/kDiBiT7Xg8b98LNBp/U1sihLm4Jk3NVRdtcdXmBdHw+IXlfuINrSmjTPEibgW0aG6mRhjIZKHrNdkqOe92R2gQYzN8RXUXgaevd6QDymcfi8tN1O2aFAm10hC25bDil+9AlQW4WiBWmEOmJCW4ZI1cIEDQDTZmBw6k/vTId2uMYNE0wpKnzO4jZx4owXawseHDf3OE/7gXUdNBsRH0MsKfMEOxluOj1NEvrfQVTqzJei1amjqBegiRPJr/tULjFgjNgi1iApG55n0a8x84GNcAMC3e71/srY2Wp2rlYeWzFdKcr8yV+YH/D4W/yjeUWX5IQMnrmXt7DL70dTg5fMpFUiWQr10jjXlO0nzWFTkFmN9JHkjdbLSv5CWqstt1JkS1odviNam1GbrW41U2OVrkmS3Hk7/4N1w+VBEv7LU/hYa2gREEU7mOyz2u8X/Q3sShOC4saSfv8a1+pWVSKJlBggQ8kBKRyy/xjCwpJm149uwaVZ8vV/rMDiAXigVRYqEmbyEeNbOILygq/mAhm04RF8StEeKxIFxpl+J+aHodqeUa5mPxojLcdmgETGvL8eMPTJFRqTNqHTsYMC5YPdiwu3PezOZugvzDbI+9q8PpOzIJ2q5KoH2DJMsqgjG0XM="
  file:
    - "$FRAMEWORK_NAME.framework.zip"
    - "$BUILD_FOLDER/$FRAMEWORK_NAME.xcframework.zip"
  skip_cleanup: true
  on:
   repo: awslabs/aws-mobile-appsync-sdk-ios
   tags: true
- provider: script
  script: bash ./build-support/cocoapods_release.sh
  on:
    repo: awslabs/aws-mobile-appsync-sdk-ios
    tags: true
